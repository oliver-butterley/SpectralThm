% In this file you should put the actual content of the blueprint.
% It will be used both by the web and the print version.
% It should *not* include the \begin{document}
%
% If you want to split the blueprint content into several files then
% the current file can be a simple sequence of \input. Otherwise It
% can start with a \section or \chapter for instance.

\section{Orthogonal projections}
(The contents of this section should be added to Mathlib.Analysis.InnerProductSpace.Projection)

Let $H$ be a complex Hilbert space and $K$ be a closed subspace of $H$.
We denote $K^\perp$ the orthogonal complement of $K$ in $H$.
Any vector $x \in H$ can be written as $x = x_K + x_{K^\perp}$, where $x_K \in K, x_{K^\perp} \in K^\perp$.
The map $p(K) : x \to x_K$ is called the orthogonal projection to $K$.
\begin{lemma}
 It holds that $p(K) = p(K)^2 = p(K)^*$.
\end{lemma}
\begin{proof}
 The first equality follows by the uniqueness of the orthogonal decomposition.

 The second equality follows because $\langle y, p(K)x \rangle = \langle y, x_K\rangle = \langle y_K, x \rangle = \langle p(K)y, x\rangle$
 by orthogonality.
\end{proof}

\begin{lemma}
 For $p \in \mathcal{B}(H)$ such that $p = p^2 = p^*$,
 there is a closed subspace $K$ such that $p = p(K)$.
\end{lemma}
\begin{proof}
 By $p = p^2$, it is a projection. Let $K$ be the image of $p$.
 Note that $x = (p + (1-p))x = px + (1-p)x$ for any $x \in H$
 and $\langle px, (1-p)x\rangle = \langle x, (p-p)x\rangle = 0$.
 So this gives the orthogonal decomposition.
\end{proof}

\begin{lemma}[12.6, part 1]
 Let $\{x_n\}$ be a sequence of pairwise orthogonal vectors in $H$.
 Then the following are equivalent.
 \begin{itemize}
  \item $\sum_{n=1}^\infty x_n$ converges in the norm topology of $H$.
  \item $\sum_{n=1}^\infty \|x_n\|^2 < \infty$.
 \end{itemize}
\end{lemma}
\begin{proof}
 Note that, by orthogonality,
 $\|\sum_{j=m}^n x_j\|^2 = \sum_{j=m}^n \|x_j\|^2$.
 Therefore, the second condition implies that the sequence $\sum_{j=1}^n x_j$ is Cauchy.

 Conversely, as $\sum_{j=1}^n x_j$ converges in norm, the square of its norm $\sum_{j=1}^n \|x_j\|^2$ converges.

\end{proof}

\begin{lemma}[12.6, part 2]
 Let $\{x_n\}$ be a sequence of pairwise orthogonal vectors in $H$.
 Then the following are equivalent.
 \begin{itemize}
  \item $\sum_{n=1}^\infty x_n$ converges in the norm topology of $H$.
  \item $\sum_{n=1}^\infty \langle x, y\rangle$ converges for all $y \in H$.
 \end{itemize}
\end{lemma}
\begin{proof}
 The first condition implies the second by Cauchy-Schwartz.

 Assume that
 $\sum_{n=1}^\infty \langle x, y\rangle$ converges for all $y \in H$.
 Define $\Lambda_n y = \sum_{j=1}^n \langle y, x_j\rangle$.
 As this converges for each $y$, by Banach-Steinhaus, $\{\|\Lambda_n\|\}$ is bounded.
 As $\|\Lambda_n\| = \sqrt{\sum_{j=1}^n \|x_j\|}$, this gives the first condition.
\end{proof}

\section{Resolutions of the identity}

\begin{definition}[12.17]
  Let $\mathfrak{M}$ be a $\sigma$-algebra in a set $\Omega$, and let $H$ be a Hilbert space.
  For simplicity, we assume that $\Omega$ is a locally compact (Hausdorff) space.
  In this setting, a \emph{resolution of the identity} (on $\mathfrak{M}$) is a mapping

  \[
    E: \mathfrak{M} \to \mathfrak{M}(H)
  \]
  with the following properties:

  \begin{enumerate}
    \item \label{itm:Ra} \( E(\emptyset) = 0\), \(E(\Omega) = I\).
    \item \label{itm:Rb}  Each \( E(\omega) \) is a self-adjoint projection.
    \item \label{itm:Rc} \( E(\omega' \cap \omega'') = E(\omega')E(\omega'')\).
    \item \label{itm:Rd}  If \( \omega' \cap \omega'' = \emptyset \), then \( E(\omega' \cup \omega'') = E(\omega') + E(\omega'') \).
    \item \label{itm:Re}  For every \( x \in H \) and \( y \in H \), the set function \( E_{x,y} \) defined by:
          \[
            E_{x,y}(\omega) = (E(\omega)x, y)
          \]
          is a complex regular Borel measure on \( \mathcal{M} \).
  \end{enumerate}
\end{definition}

% When \( \mathfrak{M} \) is the \( \sigma \)-algebra of all Borel sets on a compact or locally compact Hausdorff space, it is customary to add another requirement to (\ref{itm:Re}):
% Each \( E_{x,y} \) should be a regular Borel measure.
% (This is automatically satisfied on compact metric spaces, for instance. See [23].)

\begin{lemma}
 For any $x \in H$,
 \[
  E_{x,x}(\omega) = (E(\omega)x, x) = \|E(\omega)x\|^2.
 \]
\end{lemma}

\begin{lemma}
 For any $x \in H$,
 \( E_{x,x} \) is a positive measure on \( \mathfrak{M} \) whose total variation is:
 \[
  \|E_{x,x}\| = E_{x,x}(\Omega) = \|x\|^2.
 \]
\end{lemma}

\begin{lemma}
 For two $\omega_1, \omega_2$, \( E(\omega_1), E(\omega_2) \) commute.
\end{lemma}
\begin{proof}
 By (\ref{itm:Rc}), any two of the projections \( E(\omega) \) commute with each other.
\end{proof}

\begin{lemma}
 If \( \omega' \cap \omega'' = \emptyset \),
 then the ranges of \( E(\omega') \) and \( E(\omega'') \) are orthogonal to each other
\end{lemma}
\begin{proof}
 By (\ref{itm:Ra}), (\ref{itm:Rc}) and Theorem 12.14.
\end{proof}

\begin{lemma}
 If $\{\omega_j\}$ is a finite family of mutually disjoint Borel sets, then
 $E(\bigcup_j \omega_j) = \sum_j E(\omega_j)$.
\end{lemma}
\begin{proof}
 By (\ref{itm:Rd}) and induction.
\end{proof}

\textbf{Remark:}
$\sum_{n=1}^{\infty} E(\omega_n)$ does not converge in the norm topology of $\mathcal{B}(H)$.

\begin{lemma}
 Let $x \in H$ and $\{\omega_j\}$ be a countable family of mutually disjoint Borel sets.
 Then $E(\bigcup_j \omega_j)x = \sum_j E(\omega_j)x$, where
 the right-hand side converges in the norm topology of $H$.
\end{lemma}
\begin{proof}
 Since \( E(\omega_n)E(\omega_m) = 0 \) when \( n \neq m \), the vectors \( E(\omega_n)x \) and \( E(\omega_m)x \)
 are orthogonal to each other (Theorem 12.14).
 By (\ref{itm:Re}),
 \begin{equation}
   \label{eq:R5}
   \sum_{n=1}^{\infty} (E(\omega_n)x, y) = (E(\omega)x, y)
 \end{equation}
 for every \( y \in H \).
 It now follows from Theorem 12.6 that:
 \[
  \sum_{n=1}^{\infty} E(\omega_n)x = E(\omega)x.
 \]
 The series (\eqref{eq:R5}) converges in the norm topology of \( H \).
\end{proof}

\begin{proposition}[12.18]
  If \( E \) is a resolution of the identity, and if \( x \in H \), then
  \[
    \omega \mapsto E(\omega)x
  \]
  is a countably additive \( H \)-valued measure on* \( \mathfrak{M} \).
\end{proposition}

Moreover, sets of measure zero can be handled in the usual way:

\begin{proposition}[12.19]
  Suppose \( E \) is a resolution of the identity.
  If \( \omega_n \in \mathfrak{M} \) and \( E(\omega_n) = 0 \) for \( n = 1,2,3,\dots \), and if
  \[
    \omega = \bigcup_{n=1}^{\infty} \omega_n,
  \]
  then \( E(\omega) = 0 \).
\end{proposition}

\begin{proof}
  Since \( E(\omega_n) = 0 \), \( E_{x,x}(\omega_n) = 0 \) for every \( x \in H \). Since \( E_{x,x} \) is countably additive, it follows that \( E_{x,x}(\omega) = 0 \). But
  \[
    \|E(\omega)x\|^2 = E_{x,x}(\omega).
  \]
  Hence, \( E(\omega) = 0 \).
\end{proof}


% **12.20 The algebra \( L^{\infty}(E) \)**
% Let \( E \) be a resolution of the identity on \( \mathcal{M} \), as above. Let \( f \) be a complex \( \mathcal{M} \)-measurable function on \( \Omega \). There is a countable collection \( \{D_i\} \) of open discs that forms a base for the topology of \( \mathbb{C} \). Let \( V \) be the union of those \( D_i \) for which \( E(f^{-1}(D_i)) = 0 \). By Proposition 12.19, \( E(f^{-1}(V)) = 0 \). Also, \( V \) is the largest open subset of \( \mathbb{C} \) with this property.

% The **essential range** of \( f \) is, by definition, the complement of \( V \). It is the smallest closed subset of \( \mathbb{C} \) that contains \( f(p) \) for almost all \( p \in \Omega \), that is, for all \( p \in \Omega \) except those that lie in some set \( \omega \in \mathcal{M} \) with \( E(\omega) = 0 \).

% We say that \( f \) is **essentially bounded** if its essential range is bounded, hence compact. In that case, the largest value of \( |\lambda| \), as \( \lambda \) runs through the essential range of \( f \), is called the **essential supremum** \( \| f \|_{\infty} \) of \( f \).

% Let \( B \) be the algebra of all bounded complex \( \mathcal{M} \)-measurable functions on \( \Omega \), with the norm:

% \[
%   \| f \| = \sup \{ | f(p) | : p \in \Omega \}.
% \]

% One sees easily that \( B \) is a Banach algebra and that:

% \[
%   N = \{ f \in B : \| f \|_{\infty} = 0 \}
% \]

% is an ideal of \( B \) which is **closed**, by Proposition 12.19. Hence, \( B/N \) is a Banach algebra, which we denote (in the usual manner) by \( L^{\infty}(E) \).

% The norm of any coset \( [f] = f + N \) of \( L^{\infty}(E) \) is then equal to \( \| f \|_{\infty} \), and its spectrum \( \sigma([f]) \) is the essential range of \( f \). As is usually done in measure theory, the distinction between \( f \) and its equivalence class \( [f] \) will be ignored.

% Our next concern will be the integration of functions with respect to the projection-valued measures described above. The resulting integrals
% \(\int f \, dE\) turn out to be not only linear (as all good integrals ought to be) but also multiplicative!

% **12.21 Theorem**
% *If \( E \) is a resolution of the identity, as above, then there exists an isometric*-isomorphism* \( \Psi \) *of the Banach algebra* \( L^{\infty}(E) \) *onto a closed normal subalgebra* \( A \) *of* \( \mathcal{B}(H) \), *which is related to* \( E \) *by the formula.*

% \[
% (\Psi(f)x, y) = \int_{\Omega} f \, dE_{x,y} \quad \text{for } (x, y \in H, f \in L^{\infty}(E)).
% \]

% This justifies the notation

% \[
% \Psi(f) = \int_{\Omega} f \, dE.
% \]

% Moreover,

% \[
% \|\Psi(f)x\|^2 = \int_{\Omega} |f|^2 \, dE_{x,x} \quad \text{for } (x \in H, f \in L^{\infty}(E)).
% \]

% *And an operator* \( Q \in \mathcal{B}(H) \) *commutes with every* \( E(\omega) \) *if and only if* \( Q \) *commutes with every* \( \Psi(f) \).

% ---

% Recall that a **normal subalgebra** \( A \) of \( \mathcal{B}(H) \) is a commutative one which contains \( T^* \) for every \( T \in A \). To say that \( \Psi \) is a \( * \)-isomorphism means that \( \Psi \) is one-to-one, linear, and multiplicative and that

% \[
% \Psi(\bar{f}) = \Psi(f)^* \quad \text{for } (f \in L^{\infty}(E)).
% \]

% ---

% **Proof**
% To begin with, let \( \{\omega_1, \dots, \omega_n\} \) be a partition of \( \Omega \), with \( \omega_i \in \mathcal{M} \), and let \( s \) be a simple function, such that \( s = \alpha_i \) on \( \omega_i \). Define \( \Psi(s) \in \mathcal{B}(H) \) by

% \[
% \Psi(s) = \sum_{i=1}^{n} \alpha_i E(\omega_i).
% \]

% Since each \( E(\omega_i) \) is self-adjoint,

% \[
% \Psi(s)^* = \sum_{i=1}^{n} \bar{\alpha}_i E(\omega_i) = \Psi(\bar{s}).
% \]

% If \( \{\omega'_1, \dots, \omega'_m\} \) is another partition of this kind, and if \( t = \beta_j \) on \( \omega'_j \), then

% \[
% \Psi(s) \Psi(t) = \sum_{i,j} \alpha_i \beta_j E(\omega_i) E(\omega'_j) = \sum_{i,j} \alpha_i \beta_j E(\omega_i \cap \omega'_j).
% \]

% Since \( st \) is the simple function that equals \( \alpha_i \beta_j \) on \( \omega_i \cap \omega_j \), it follows that

% \[
% \Psi(s) \Psi(t) = \Psi(st).
% \]

% An entirely analogous argument shows that

% \[
% \Psi(\alpha s + \beta t) = \alpha \Psi(s) + \beta \Psi(t).
% \]

% If \( x \in H \) and \( y \in H \), (5) leads to

% \[
% (\Psi(s)x, y) = \sum_{i=1}^{n} \alpha_i (E(\omega_i)x, y) = \sum_{i=1}^{n} \alpha_i E_{x,y}(\omega_i) = \int_{\Omega} s \, dE_{x,y}.
% \]

% By (6) and (7),

% \[
% \Psi(s)^* \Psi(s) = \Psi(\bar{s}) \Psi(s) = \Psi(\bar{s} s) = \Psi(|s|^2).
% \]

% Hence (9) yields

% \[
% \|\Psi(s)x\|^2 = (\Psi(s)^* \Psi(s)x, x) = (\Psi(|s|^2)x, x) = \int_{\Omega} |s|^2 dE_{x,x},
% \]

% so that

% \[
% \|\Psi(s)x\| \leq \|s\|_{\infty} \|x\|,
% \]

% by formula (2) of Section 12.17. On the other hand, if \( x \in \mathcal{R}(E(\omega_j)) \), then

% \[
% \Psi(s)x = \alpha_j E(\omega_j)x = \alpha_j x,
% \]

% since the projections \( E(\omega_i) \) have mutually orthogonal ranges. If \( j \) is chosen so that \( |\alpha_j| = \|s\|_{\infty} \), it follows from (12) and (13) that

% \[
% \|\Psi(s)\| = \|s\|_{\infty}.
% \]

% Now suppose \( f \in L^{\infty}(E) \). There is a sequence of simple measurable functions \( s_k \) that converges to \( f \) in the norm of \( L^{\infty}(E) \). By (14), the corresponding operators \( \Psi(s_k) \) form a Cauchy sequence in \( \mathcal{B}(H) \) which is therefore norm-convergent to an operator that we call \( \Psi(f) \); it is easy to see that \( \Psi(f) \) does not depend on the particular choice of \( \{s_k\} \). Obviously (14) leads to

% \[
% \|\Psi(f)\| = \|f\|_{\infty}, \quad (f \in L^{\infty}(E)).
% \]

% Now (1) follows from (9) (with \( s_k \) in place of \( s \)), since each \( E_{x,x} \) is a finite measure; (2) and (3) follow from (6) and (11); and if bounded measurable functions \( f \) and \( g \) are approximated, in the norm of \( L^{\infty}(E) \), by simple measurable functions \( s \) and \( t \), we see that (7) and (8) hold with \( f \) and \( g \) in place of \( s \) and \( t \).

% Thus Ψ is an isometric isomorphism of \( L^\infty(E) \) into \( \mathcal{B}(H) \). Since \( L^\infty(E) \) is complete, its image \( A = \Psi(L^\infty(E)) \) is closed in \( \mathcal{B}(H) \), because of (15).

% Finally, if \( Q \) commutes with every \( E(\omega) \), then \( Q \) commutes with \( \Psi(s) \) whenever \( s \) is simple, and therefore the approximation process used above shows that \( Q \) commutes with every member of \( A \). \(\quad \////\)

% It is perhaps worth mentioning that the equality

% \[
% (16) \quad \| f \|_\infty^2 = \sup \left\{ \int_\Omega |f|^2 \, dE_{x,x} : \| x \| \leq 1 \right\}
% \]

% holds for every \( f \in L^\infty(E) \), because of (3) and (15).








\section{The Spectral Theorem}

%   \proves{}
%   \uses{}

\begin{quotation}
  \emph{Functional Analysis by Walter Rudin 1991, extract from Chapter 12}
\end{quotation}

The principal assertion of the spectral theorem is that every bounded normal operator $T$ on a Hilbert space induces (in a canonical way) a resolution $E$ of the identity on the Borel subsets of its spectrum $\sigma(T)$ and that $T$ can be reconstructed from $E$ by an integral of the type discussed in Theorem 12.21.
A large part of the theory of normal operators depends on this fact.

It should perhaps be stated explicitly that the spectrum $\sigma(T)$ of an operator $T \in \mathcal{B}(H)$ will always refer to the full algebra $\mathcal{B}(H)$.
In other words, $\lambda \in \sigma(T)$ if and only if $T - \lambda I$ has no inverse in $\mathcal{B}(H)$.
Sometimes we shall also be concerned with closed subalgebras $A$ of $\mathcal{B}(H)$ which have the additional property that $I \in A$ and $T^* \in A$ whenever $T \in A$. (Such algebras are sometimes called $*$-algebras.)

Let $A$ be such an algebra, and suppose that $T \in A$ and $T^{-1} \in \mathcal{B}(H)$.
Since $TT^*$ is self-adjoint, $\sigma(TT^*)$ is a compact subset of the real line (Theorem 12.15), hence does not separate $\mathbb{C}$, and therefore $\sigma_A(TT^*) = \sigma(TT^*)$, by the corollary to Theorem 10.18.
Since $TT^*$ is invertible in $\mathcal{B}(H)$, this equality shows that $(TT^*)^{-1} \in A$, and therefore $T^{-1} = T^(TT^*)^{-1}$ is also in $A$.

Thus $T$ has the same spectrum relative to all closed *-algebras in $\mathcal{B}(H)$ that contain $T$.

Theorem 12.23 will be obtained as a special case of the following result, which deals with normal algebras of operators rather than with individual ones.

\begin{theorem}[12.22]

  If $A$ is a closed normal subalgebra of $\mathcal{B}(H)$ which contains the identity operator $I$ and if $\Delta$ is the maximal ideal space of $A$, then the following assertions are true:

  \begin{enumerate}
    \item \label{itm:a} There exists a unique resolution $E$ of the identity on the Borel subsets of $\Delta$ which satisfies
          \begin{equation}
            \label{eq:1}
            T = \int_\Delta \widehat{T} \ dE
          \end{equation}
          for every $T \in A$, where $\widehat{T}$ is the Gelfand transform of $T$.
    \item \label{itm:b} The inverse of the Gelfand transform (i.e., the map that takes $\widehat{T}$ back to $T$) extends to an isometric *-isomorphism of the algebra \(L^\infty(E)\) onto a closed subalgebra $B$ of $\mathcal{B}(H)$, $B\supset A$, given by
          \begin{equation}
            \label{eq:2}
            \Phi f = \int_\Delta f \ dE \quad (f \in L^\infty(E)).
          \end{equation}
          Explicitly, $\Phi$ is linear and multiplicative and satisfies
          \[
            \Phi(\bar{f}) = (\Phi f)^*, \| \Phi f \| = \| f \|_{\infty} \quad (f \in L^\infty(E)).
          \]
    \item \label{itm:c}  $B$ is the closure [in the norm topology of  $\mathcal{B}(H)$] of the set of all finite linear combinations of the projections $E(\omega)$.
    \item \label{itm:d}  If $\omega \subset \Delta$ is open and nonempty, then $E(\omega) \neq 0$.
    \item \label{itm:e}  An operator $S \in \mathcal{B}(H)$ commutes with every $T \in A$ if and only if $S$ com mutes with every projection $E(\omega)$.
  \end{enumerate}
\end{theorem}

\begin{proof}
  Recall that \eqref{eq:1} is an abbreviation for
  \begin{equation}
    \label{eq:4}
    (Tx , y) = \int_\Delta \widehat{T} \ dE_{x,y} \quad (x,y \in H, T \in A).
  \end{equation}
  Since $\mathcal{B}(H)$ is a $B^*$-algebra (Section 12.9), our given algebra $A$ is a commutative $B^*$-algebra.
  The Gelfand-Naimark theorem 11.18 asserts therefore that $T \to \widehat{T}$ is an isometric *-isomorphism of $A$ onto $C(\Delta)$.

  This leads to an easy proof of the uniqueness of $E$.
  Suppose $E$ satisfies \eqref{eq:4}.
  Since $\widehat{T}$ ranges over all of $C(\Delta)$, the assumed regularity of the complex Borel measures $E_{x,y}$ shows that each $E_{x,y}$ is uniquely determined by \eqref{eq:4}; this follows from the uniqueness assertion that is part of the Riesz representation theorem ([23], Th. 6.19).
  Since, by definition, $(E(\omega)x, y) = E_{x,y}(\omega)$, each projection $E(\omega))$ is also uniquely determined by \eqref{eq:4}.

  This uniqueness proof motivates the following proof of the existence of $E$.
  If $x \in H$ and $y \in H$, Theorem 11.18 shows that $ \widehat{T} \mapsto (Tx, y)$ is a bounded linear functional on $C(\Delta)$, of norm $\leq \|x\|| \|y\|$, since $\| \widehat{T}\|_{\infty} = \|T\|$.
  The Riesz representation theorem supplies us therefore with unique regular complex Borel measures $\mu_{x,y}$ on $\Delta$ such that
  \begin{equation}
    \label{eq:5}
    (Tx , y) = \int_\Delta \widehat{T} \ d\mu_{x,y} \quad (x,y \in H, T \in A).
  \end{equation}
  For fixed \( T \), the left side of \eqref{eq:5} is a bounded sesquilinear functional on \( H \), hence so is the right side, and it remains so if the continuous function
  \( \widehat{T} \) is replaced by an arbitrary bounded Borel function \( f \).
  To each such \( f \) corresponds therefore an operator \( \Phi f \in \mathcal{B}(H) \) (see Theorem 12.8) such that

  \begin{equation}
    \label{eq:6}
    ((\Phi f)x, y) = \int_{\Delta} f \ d\mu_{x,y} \quad (x, y \in H).
  \end{equation}

  Comparison of \eqref{eq:5} and \eqref{eq:6} shows that \( \Phi \hat{T} = T \). Thus \( \Phi \) is an extension of the inverse of the Gelfand transform.

  It is clear that \( \Phi \) is linear.

  Part of the Gelfand-Naimark theorem states that \( T \) is self-adjoint if and only if \( \hat{T} \) is real-valued. For such \( T \),

  \[
    \int_{\Delta} \widehat{T} \ d\mu_{x,y} = (Tx, y) = (x, Ty) = \overline{(Ty, x)} = \overline{\int_{\Delta} \hat{T} d\mu_{y,x}},
  \]

  and this implies that \( \mu_{y,x} = \overline{\mu_{x,y}} \).
  Hence,

  \[
    ((\Phi \overline{f})x, y) = \int_{\Delta} \bar{f} \ d\mu_{x,y} = \overline{\int_{\Delta} f \, d\mu_{y,x}} = \overline{((\Phi f)y, x)} = (x, (\Phi f)y)
  \]

  for all \( x, y \in H \), so that

  \begin{equation}
    \label{eq:7}
    \Phi \bar{f} = (\Phi f)^*.
  \end{equation}

  Our next objective is the equality

  \begin{equation}
    \label{eq:8}
    \Phi (fg) = (\Phi f)(\Phi g)
  \end{equation}

  for bounded Borel functions \( f, g \) on \( \Delta \). If \( S \in A \) and \( T \in A \), then
  \( (ST)^{\wedge} = \widehat{S} \widehat{T} \);
  hence

  \[
    \int_{\Delta} \hat{S} \hat{T} \ d\mu_{x,y} = (STx, y) = \int_{\Delta} \widehat{S} \ d\mu_{Tx,y}.
  \]

  This holds for every \( \widehat{S} \in C(\Delta) \);
  hence the two integrals are equal if \( \widehat{S} \) is
  replaced by any bounded Borel function \( f \). Thus

  \[
    \int_{\Delta} f \widehat{T} d\mu_{x,y} = \int_{\Delta} f \ d\mu_{Tx,y} = ((\Phi f)Tx, y) = (Tx, z) = \int_{\Delta} \hat{T} d\mu_{x,z},
  \]

  where we put \( z = (\Phi f)^* y \).
  Again, the first and last integrals remain
  equal if \( \widehat{T} \) is replaced by \( g \).
  This gives

  \[
    \begin{aligned}
      (\Phi (fg)x, y) & = \int_{\Delta} fg \ d\mu_{x,y} = \int_{\Delta} g \ d\mu_{x,z}          \\
                      & = ((\Phi g)x, z) = ((\Phi g)x, (\Phi f)^* y) = (\Phi (f) \Phi (g)x, y),
    \end{aligned}
  \]

  and \eqref{eq:8} is proved.

  We are finally ready to define \( E \): If \( \omega \) is a Borel subset of \( \Delta \), let
  \( \chi_{\omega} \) be its characteristic function, and put

  \[
    E(\omega) = \Phi(\chi_{\omega}).
  \]

  By \eqref{eq:8}, \( E(\omega \cap \omega') = E(\omega)E(\omega') \).
  With \( \omega' = \omega \), this shows that
  each \( E(\omega) \) is a projection.
  Since \( \Phi f \) is self-adjoint when \( f \) is real, by \eqref{eq:7},
  each \( E(\omega) \) is self-adjoint.
  It is clear that \( E(\emptyset) = \Phi(0) = 0 \).
  That
  \( E(\Delta) = I \) follows from \eqref{eq:5} and \eqref{eq:6}.
  The finite additivity of \( E \) is a consequence
  of \eqref{eq:6}, and, for all \( x, y \in H \),

  \[
    E_{x,y}(\omega) = (E(\omega)x, y) = \int_{\Delta} \chi_{\omega} \ d\mu_{x,y} = \mu_{x,y}(\omega).
  \]

  Thus \eqref{eq:6} becomes \eqref{eq:2}.
  That \( \|\Phi f\| = \|f\|_{\infty} \) follows now from Theorem 12.21.

  This completes the proof of (\ref{itm:a}) and (\ref{itm:b}).

  Part (\ref{itm:c}) is now clear because every \( f \in L^{\infty}(E) \) is a uniform limit of
  simple functions (i.e., of functions with only finitely many values).

  Suppose next that \( \omega \) is open and \( E(\omega) = 0 \).
  If \( T \in A \) and \( \widehat{T} \) has
  its support in \( \omega \), \eqref{eq:1} implies that \( T = 0 \); hence \( \widehat{T} = 0 \).
  Since \( \widehat{A} = C(\Delta) \),
  Urysohn's lemma implies now that \( \omega = \emptyset \).
  This proves (\ref{itm:d}).

  To prove (\ref{itm:e}), choose \( S \in \mathcal{B}(H) \), \( x \in H \), \( y \in H \), and put \( z = S^* y \).
  For any \( T \in A \) and any Borel set \( \omega \subset \Delta \) we then have

  \begin{equation}
    \label{eq:10}
    (STx, y) = (Tx, z) = \int_{\Delta} \widehat{T} \ dE_{x,z},
  \end{equation}

  \begin{equation}
    \label{eq:11}
    (TSx, y) = \int_{\Delta} \hat{T} \ dE_{Sx,y},
  \end{equation}

  \[
    (SE(\omega)x, y) = (E(\omega)x, z) = E_{x,z}(\omega),
  \]

  \[
    (E(\omega)Sx, y) = E_{Sx,y}(\omega).
  \]

  If \( ST = TS \) for every \( T \in A \), the measures in \eqref{eq:10} and \eqref{eq:11} are
  equal, so that \( SE(\omega) = E(\omega)S \).
  The same argument establishes the converse.
  This completes the proof.
\end{proof}
